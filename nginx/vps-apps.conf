# nginx/vps-apps.conf — canonical nginx configuration for the VPS.
#
# Apply on the VPS:
#   sudo cp nginx/vps-apps.conf /etc/nginx/sites-available/vps-apps
#   sudo ln -sf /etc/nginx/sites-available/vps-apps /etc/nginx/sites-enabled/vps-apps
#   sudo nginx -t && sudo systemctl reload nginx
#
# This file is the source of truth for all reverse-proxy routing.
# Keep it in sync with the running server when adding new projects.

server {
    listen 80;
    server_name 213.199.32.18;

    # Static frontend files (Projects 3 + 4 web dashboards)
    root /var/www/portfolio;
    index index.html;

    # ── Health check ─────────────────────────────────────────────────────────
    # Responds 200 immediately without touching any backend — useful for
    # load balancers, uptime monitors, and deploy smoke tests.
    location = /health {
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    # ── Device Manager REST API → Spring Boot :8080 ──────────────────────────
    location /api/v1/ {
        proxy_pass         http://localhost:8080/api/v1/;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_read_timeout 60s;
    }

    # ── Swagger UI (SpringDoc default paths) ────────────────────────────────
    # SpringDoc serves the UI at /swagger-ui/index.html and the OpenAPI spec
    # JSON at /v3/api-docs.  Both must be proxied for the UI to load fully.
    location /swagger-ui/ {
        proxy_pass         http://localhost:8080/swagger-ui/;
        proxy_http_version 1.1;
        proxy_set_header   Host $host;
    }

    location /v3/api-docs {
        proxy_pass         http://localhost:8080/v3/api-docs;
        proxy_http_version 1.1;
        proxy_set_header   Host $host;
    }

    # ── Arcade Hub REST API → Spring Boot :8081 (Project 4) ─────────────────
    location /arcade/api/ {
        proxy_pass         http://localhost:8081/arcade/api/;
        proxy_http_version 1.1;
        proxy_set_header   Host        $host;
        proxy_set_header   X-Real-IP   $remote_addr;
        proxy_read_timeout 60s;
    }

    # ── Arcade Hub WebSocket → :8081 ─────────────────────────────────────────
    # WebSocket upgrades require special headers.  The Connection header must
    # be set to "upgrade" (not "keep-alive") and proxy_read_timeout must be
    # much longer than a normal HTTP request — 3600s = 1 hour idle tolerance.
    location /arcade/ws/ {
        proxy_pass         http://localhost:8081/arcade/ws/;
        proxy_http_version 1.1;
        proxy_set_header   Upgrade    $http_upgrade;
        proxy_set_header   Connection "upgrade";
        proxy_set_header   Host       $host;
        proxy_read_timeout 3600s;
    }

    # ── SPA fallback ─────────────────────────────────────────────────────────
    # For single-page apps (device-manager-web, arcade-hub-web): serve the
    # requested file if it exists, the directory if it exists, otherwise fall
    # back to /index.html so client-side routing works without 404s.
    location / {
        try_files $uri $uri/ /index.html;
    }
}
